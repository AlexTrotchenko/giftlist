---
import { eq, or } from "drizzle-orm";
import { GroupsPage } from "@/components/GroupsPage";
import { groupMembers, groups, users } from "@/db/schema";
import AppLayout from "@/layouts/AppLayout.astro";
import { getAuthAdapter } from "@/lib/auth";
import { createDb } from "@/lib/db";
import { getLocale, localizeHref } from "@/paraglide/runtime";

const db = createDb(Astro.locals.runtime.env.DB);
const auth = getAuthAdapter(Astro.locals.runtime.env);

const authUser = await auth.getCurrentUser(Astro.request, Astro.locals);
const locale = getLocale();

if (!authUser) {
	return Astro.redirect(localizeHref("/"));
}

// Look up internal user by Clerk ID, create if doesn't exist (handles missing webhook)
let user = await db
	.select()
	.from(users)
	.where(eq(users.clerkId, authUser.providerId))
	.get();

if (!user) {
	// User authenticated but not in DB (webhook not received) - create them
	const [newUser] = await db
		.insert(users)
		.values({
			clerkId: authUser.providerId,
			email: authUser.email,
			name: authUser.name,
			avatarUrl: authUser.avatarUrl,
		})
		.returning();
	user = newUser;
}

// Get groups where user is a member
const memberships = await db
	.select({ groupId: groupMembers.groupId })
	.from(groupMembers)
	.where(eq(groupMembers.userId, user.id));

const memberGroupIds = memberships.map((m) => m.groupId);

// Get all groups where user is owner or member
const userGroups = await db
	.select()
	.from(groups)
	.where(
		memberGroupIds.length > 0
			? or(
					eq(groups.ownerId, user.id),
					...memberGroupIds.map((id) => eq(groups.id, id)),
				)
			: eq(groups.ownerId, user.id),
	);

// Serialize dates to ISO strings for React hydration
const serializedGroups = userGroups.map((group) => ({
	...group,
	createdAt: group.createdAt?.toISOString() ?? null,
	updatedAt: group.updatedAt?.toISOString() ?? null,
}));
---

<AppLayout title="My Groups - GiftList" locale={locale}>
	<GroupsPage client:load initialGroups={serializedGroups} />
</AppLayout>
